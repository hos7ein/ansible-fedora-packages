---
- name: Check that user exists
  shell: "grep {{ username }} /etc/passwd"
  ignore_errors: yes
  register: userexist

- name: Adding existing user "{{ username }}" to group libvirt
  user:
    name: "{{ username }}"
    groups: libvirt
    append: yes
  when: userexist.rc == 0

- name: Install docker-machine-driver-kvm2
  get_url:
    url: https://storage.googleapis.com/minikube/releases/latest/docker-machine-driver-kvm2
    dest: /usr/local/bin/docker-machine-driver-kvm2
    mode: '0555'

- name: Install Minikube
  get_url:
    url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    dest: /usr/local/bin/minikube
    mode: '0555'

- name : Install kubectl
  dnf:
    name:
      - kubernetes-client
    state: present
  retries: 3
  delay: 5
  register: result
  until: result is succeeded

- name: Install kubecolor
  unarchive:
    src: https://github.com/hidetatz/kubecolor/releases/download/v0.0.20/kubecolor_0.0.20_Linux_x86_64.tar.gz
    dest: /usr/local/bin
    remote_src: yes
    mode: 0555
    extra_opts:
      - "--add-file"
      - "kubecolor"

- name: Add kubecolor to bashrc file
  lineinfile:
    path: "/home/{{ username }}/.bashrc"
    line: "{{ item }}"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: 0644
  with_items:
    - alias kubectl=kubecolor
    - complete -o default -F __start_kubectl kubecolor
  when: userexist.rc == 0
