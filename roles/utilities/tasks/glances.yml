# - name: Enable and start Podman socket
#   ansible.builtin.systemd:
#     name: podman.socket
#     scope: global
#     state: started
#     enabled: true
#   # become: true
#   # become_user: "{{ username }}"

- name: Check if podman.socket exists
  ansible.builtin.stat:
    path: /etc/systemd/user/sockets.target.wants/podman.socket
  register: podman_socket

- name: Enable and start Podman socket if missing
  ansible.builtin.systemd:
    name: podman.socket
    scope: global
    state: started
    enabled: true
  when: not podman_socket.stat.exists

- name: Install required OS dependencies
  ansible.builtin.dnf:
    name:
      - python3
      - python3-pip
      - python3-virtualenv
    state: present
  retries: 3
  delay: 5
  register: utilities_glances_result
  until: utilities_glances_result is succeeded

- name: Create Glances base directory
  ansible.builtin.file:
    path: /opt/glances
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Create Python virtual environment (if not exists)
  ansible.builtin.command:
    cmd: "python3 -m venv /opt/glances/venv"
  args:
    creates: "/opt/glances/venv/bin/activate"

- name: Upgrade pip inside virtualenv
  ansible.builtin.pip:
    name: pip
    state: present
    virtualenv: /opt/glances/venv
    virtualenv_command: "python3 -m venv"

- name: Install Glances with containers support
  ansible.builtin.pip:
    name: "glances[containers]"
    state: present
    virtualenv: /opt/glances/venv
    virtualenv_command: "python3 -m venv"

- name: Create global executable symlink
  ansible.builtin.file:
    src: /opt/glances/venv/bin/glances
    dest: /usr/local/bin/glances
    state: link
    force: true

- name: Verify Glances installation
  ansible.builtin.command:
    cmd: "/usr/local/bin/glances --version"
  register: utilities_glances_output
  changed_when: false

- name: Show Glances installed version
  ansible.builtin.debug:
    msg: "âœ… Glances installed successfully: {{ utilities_glances_output.stdout }}"
