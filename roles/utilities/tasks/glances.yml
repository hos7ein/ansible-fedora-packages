- name: Enable and start Podman socket for user {{ username }}
  ansible.builtin.systemd:
    name: podman.socket
    scope: user
    state: started
    enabled: true
  when: pre_check_userexist.rc == 0

- name: Install required OS dependencies
  ansible.builtin.dnf:
    name:
      - python3
      - python3-pip
      - python3-virtualenv
    state: present
  retries: 3
  delay: 5
  register: utilities_glances_result
  until: utilities_glances_result is succeeded

- name: Create Glances base directory
  ansible.builtin.file:
    path: /opt/glances
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Create Python virtual environment (if not exists)
  ansible.builtin.command:
    cmd: "python3 -m venv /opt/glances/venv"
  args:
    creates: "/opt/glances/venv/bin/activate"

- name: Upgrade pip inside virtualenv
  ansible.builtin.pip:
    name: pip
    state: present
    virtualenv: /opt/glances/venv
    virtualenv_command: "python3 -m venv"

- name: Install Glances with containers support
  ansible.builtin.pip:
    name: "glances[containers]"
    state: present
    virtualenv: /opt/glances/venv
    virtualenv_command: "python3 -m venv"

- name: Create global executable symlink
  ansible.builtin.file:
    src: /opt/glances/venv/bin/glances
    dest: /usr/local/bin/glances
    state: link
    force: true

- name: Verify Glances installation
  ansible.builtin.command:
    cmd: "/usr/local/bin/glances --version"
  register: utilities_glances_output
  changed_when: false

- name: Show Glances installed version
  ansible.builtin.debug:
    msg: "âœ… Glances installed successfully: {{ utilities_glances_output.stdout }}"
